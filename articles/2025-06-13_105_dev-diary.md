```markdown
---
title: "OASISを利用したNote.com自動投稿システム開発（開発日記 No.105）"
emoji: "📝"
type: "idea"
topics: ["開発日記", "プログラミング", "自動投稿"]
published: false
---

:::message
この記事はgemini-2.5-flash-preview-04-17によって自動生成されています。
:::

## 関連リンク

- [前回の開発日記](https://zenn.dev/centervil/articles/2025-06-12_104_dev-diary)

## はじめに

昨日はNote.comへの自動投稿システム開発に向け、OASISというPythonモジュールを利用した投稿の自動化を検討しました。今日は、その続きとして、OASISの動作検証、投稿スクリプトの実装、そしてGithubActionsでのパイプライン化を目指します。

## 背景と目的

セキュリティ関連の記事をNote.comに自動で投稿する仕組みを構築することで、情報発信の効率化を図ります。OASISというモジュールを利用し、GithubActionsのパイプラインとして実装することで、記事の追加と同時に自動的にNote.comへ投稿される環境を構築します。ローカル環境での動作検証も可能にするため、単一のスクリプトファイルに処理をまとめます。

## 検討内容

OASISの動作検証から開始し、仮想環境の構築、認証情報の確認、API接続テストを行います。その後、投稿スクリプトをTDD（テスト駆動開発）で実装し、ローカルでの動作検証を経て、GithubActionsのパイプラインを実装します。

## 実装内容

1.  **OASISの動作検証:**

    まず、仮想環境を作成し、OASISモジュールをインストールしました。

    ```bash
    python3 -m venv .venv_note_oasis
    ```

    ```bash
    source .venv_note_oasis/bin/activate && pip install --upgrade pip && pip install oasis-note
    ```

    しかし、OASISという名前のNote.com投稿用PythonモジュールはPyPIに存在しないことが判明しました。

2.  **代替モジュールの調査と導入:**

    Zennの記事から、`oasis-article`というモジュールがNote.comへのクロス投稿ツールとして紹介されていることを確認しました。

    ```bash
    pip install -U oasis-article
    ```

    `.env`ファイルにNote.comの認証情報を設定する必要があるため、サンプルファイルを作成しました。

    ```bash
    echo -e '# OASIS（oasis-article）用 .env サンプル\n\n# Note.com 認証情報\nNOTE_EMAIL=your_note_email@example.com\nNOTE_PASSWORD=your_note_password\nNOTE_USER_ID=your_note_user_id\n\n# （必要に応じて他サービスの認証情報も追記可能）\n# QIITA_TOKEN=your_qiita_api_token\n# AUTH_USER=your_wordpress_username\n# AUTH_PASS=your_wordpress_password\n# BASE_URL=https://your_wordpress_site.com\n# GEMINI_API_KEY=your_gemini_api_key\n' > .env.example
    ```

3.  **投稿スクリプトの実装:**

    TDD（テスト駆動開発）の準備として、スクリプトを保存するための`tools`フォルダとテストを保存するための`tests`フォルダを作成しました。

    ```bash
    mkdir -p tools tests
    ```

    OASISのヘルプ情報を確認し、スクリプトの引数などを調査しました。

    ```bash
    .venv_note_oasis/bin/oasis --help | tee tools/oasis_help.txt
    ```

    簡単なサンプル記事を作成し、Note.comへの投稿テストを行いました。

    ```bash
    mkdir -p tools/sample-article && echo -e '# サンプル記事\n\nOASISによるNote.com自動投稿テスト。' > tools/sample-article/sample.md
    ```

    ```bash
    .venv_note_oasis/bin/oasis tools/sample-article --note --note-email dummy@example.com --note-password dummy_pass --note-user-id dummy_id --firefox-headless > tools/oasis_note_test_output.txt 2>&1
    ```

    この際、OASISのCLIは「投稿対象フォルダ」を`--folder_path`オプションで指定する必要があることが判明しました。

    正しいコマンドで再度Note.com投稿テストを実施しました。

    ```bash
    .venv_note_oasis/bin/oasis --folder_path tools/sample-article --note --note-email dummy@example.com --note-password dummy_pass --note-user-id dummy_id --firefox-headless > tools/oasis_note_test_output2.txt 2>&1
    ```

    しかし、Note.com認証情報が未設定のため、Note投稿機能は無効であるという警告が表示されました。

    次に、自動投稿スクリプト（`tools/note_post.py`）の雛形を作成しました。

    ```python
    import argparse
    import subprocess
    import sys
    from pathlib import Path


    def main():
        parser = argparse.ArgumentParser(description="指定ディレクトリ内のMarkdownをNote.comに投稿する（OASIS利用）")
        parser.add_argument('--folder', required=True, help='投稿対象のMarkdownファイルが入ったディレクトリ')
        parser.add_argument('--note-email', required=False, help='Note.comのメールアドレス（省略時は.env参照）')
        parser.add_argument('--note-password', required=False, help='Note.comのパスワード（省略時は.env参照）')
        parser.add_argument('--note-user-id', required=False, help='Note.comのユーザーID（省略時は.env参照）')
        parser.add_argument('--firefox-headless', action='store_true', help='Firefoxをヘッドレスで実行')
        args = parser.parse_args()

        folder_path = Path(args.folder)
        if not folder_path.exists() or not folder_path.is_dir():
            print(f"[ERROR] 指定ディレクトリが存在しません: {folder_path}")
            sys.exit(1)

        # OASISコマンド組み立て
        cmd = [
            sys.executable.replace('python', 'oasis'),
            '--folder_path', str(folder_path),
            '--note'
        ]
        if args.note_email:
            cmd += ['--note-email', args.note_email]
        if args.note_password:
            cmd += ['--note-password', args.note_password]
        if args.note_user_id:
            cmd += ['--note-user-id', args.note_user_id]
        if args.firefox_headless:
            cmd += ['--firefox-headless']

        print(f"[INFO] 実行コマンド: {' '.join(cmd)}")
        result = subprocess.run(cmd, capture_output=True, text=True)
        print(result.stdout)
        if result.stderr:
            print(result.stderr, file=sys.stderr)
        if result.returncode != 0:
            print(f"[ERROR] 投稿処理に失敗しました (exit code: {result.returncode})", file=sys.stderr)
            sys.exit(result.returncode)

    if __name__ == '__main__':
        main()
    ```

4.  **テストの実装:**

    スクリプトのテストコード（`tests/`配下にテスト雛形を作成）を作成しました。

    ```python
    import subprocess
    import sys
    from pathlib import Path

    def test_no_args():
        result = subprocess.run([sys.executable, 'tools/note_post.py'], capture_output=True, text=True)
        assert result.returncode != 0
        assert 'usage:' in result.stderr or 'usage:' in result.stdout

    def test_invalid_folder():
        result = subprocess.run([
            sys.executable, 'tools/note_post.py', '--folder', 'not_exist_dir'
        ], capture_output=True, text=True)
        assert result.returncode != 0
        assert '存在しません' in result.stdout
    ```

    テストを実行するためにpytestをインストールしました。

    ```bash
    .venv_note_oasis/bin/python -m pip install pytest
    ```

    作成したテストコードを実行しました。

    ```bash
    .venv_note_oasis/bin/python -m pytest tests/ > tests/pytest_result.txt 2>&1
    ```

    基本テストはすべてパスしました。

    次に、実際のNote.com投稿を`note_post.py`で実行し、自動投稿が正常に動作するか検証しました。

    ```bash
    .venv_note