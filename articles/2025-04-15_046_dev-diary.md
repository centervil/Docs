---
title: note.com APIクライアントのTDD実装（開発日記 No.046）
emoji: 📝
type: idea
topics: ["開発日記", "APIクライアント", "TDD"]
published: false
---
:::message
この記事はgemini-2.0-flash-001によって自動生成されています。
:::

## 関連リンク
- [前回の開発日記](https://zenn.dev/centervil/articles/2025-04-14_045_dev-diary)

## はじめに

昨日はOpenRouter APIクライアントの実装をTDDで完了させ、詳細設計書も改善しました。今日はその流れを受け、記事投稿機能を担うnote.com APIクライアントの実装にTDDで挑戦します。

## 背景と目的

OpenRouter APIクライアントの実装が一段落したので、次は記事を実際に投稿する機能の実装が必要です。note.com APIクライアントは、セッション管理、下書き投稿、記事メタデータ設定など、記事投稿に必要な機能を提供します。TDDを採用することで、品質の高い、テストしやすいクライアントを構築することを目指します。

## 検討内容

まず、note.com APIの仕様を調査し、必要な機能を洗い出しました。具体的には、以下の機能を実装する必要があると考えました。

*   セッションベース認証（CSRFトークン取得と管理）
*   セッション有効期限管理と自動再認証
*   下書き記事の作成API
*   マークダウンからHTMLへの変換
*   エラー処理とリトライロジック

これらの機能をTDDで実装するために、テストケースを先に設計し、それに基づいて実装を進めることにしました。

## 実装内容

TDDの原則に従い、まずテストコードから記述しました。`tests/unit/test_note_api_client.py` に、以下の機能をテストするコードを記述しました。

*   初期化と設定値の検証
*   ログイン機能とCSRFトークン取得
*   セッション管理（有効期限確認と自動再ログイン）
*   下書き記事の作成
*   マークダウンからHTMLへの変換
*   エラー処理（認証エラー、レートリミット、サーバーエラー）

次に、これらのテストをパスするように `scripts/note_api_client.py` に `NoteApiClient` クラスを実装しました。セッションベース認証、CSRFトークンの取得と管理、note.com APIへの記事投稿機能、エラーハンドリングとリトライロジックなどを実装しました。

Dockerコンテナ内でテストを実行したところ、初期段階で3つの不具合が見つかりました。具体的には、CSRFトークンのエラー処理、セッション管理、HTML変換に関する問題でした。これらの不具合を修正し、実装を改善しました。

```bash
docker-compose run --rm test
```

上記のコマンドでテストを実行した結果、45テスト中43テストが成功し、2つのテストケースが失敗しました。

失敗したテストは以下の2つです：
1. `test_ensure_login_already_logged_in` - セッションが有効な場合にloginメソッドが呼ばれないことを確認するテスト
2. `test_format_markdown_to_html` - マークダウンからHTMLへの変換処理に関するテスト

これらのテストケースが示す問題点を修正するために、セッション管理ロジックとマークダウン変換処理を見直す必要があります。

## 技術的なポイント

今回の実装で特に重要だったのは、セッション管理とCSRFトークンの扱いでした。note.comのAPIはセッションベース認証を採用しており、CSRFトークンを適切に管理する必要があります。セッションの有効期限を監視し、必要に応じて自動的に再認証を行うロジックを実装しました。また、マークダウンからHTMLへの変換処理も、note.comの仕様に合わせたHTMLを出力する必要があり、細かい調整が必要でした。

## 所感

OpenRouter APIクライアントに続き、note.com APIクライアントの実装に着手しましたが、やはりAPIクライアントの実装は奥が深いと感じました。特に、セッション管理や認証処理は、セキュリティに関わる部分でもあるため、慎重に実装する必要がありました。TDDで進めることで、テストを通じて仕様を理解し、より堅牢なコードを書くことができたと思います。Docker環境でのテスト実行は、開発環境と本番環境の差異を吸収し、安定した動作を保証するために不可欠だと改めて感じました。テストが2つ失敗してしまったので、明日以降に修正します。

## 今後の課題

今回の実装では、まだ2つのテストケースが失敗しています。これらのテストケースを修正し、すべてのテストがパスするように改善する必要があります。また、統合テストを実施し、実際の投稿機能が正常に動作することを確認する必要があります。

## まとめ

今日は、note.com APIクライアントのTDD実装に取り組みました。セッション管理、CSRFトークン、下書き投稿などの機能を実装し、初期段階のテストをクリアしました。残りのテストケースを修正し、統合テストを実施することで、より完成度の高いAPIクライアントを目指します。