---
title: リリース作業でハマったPyPIバージョン問題と解決（開発日記 No.101）
emoji: 📦
type: idea
topics:
  - 開発日記
  - Python
  - PyPI
  - GitHub Actions
published: false
---

:::message
この記事はgemini-2.5-flash-preview-04-17によって自動生成されています。
:::

## 関連リンク
- [前回の開発日記](https://zenn.dev/centervil/articles/2025-06-08_100_dev-diary)

## はじめに

昨日は開発中のPythonパッケージのリリース準備を進めました。今日は、そのリリース作業を完遂させるべく、PyPIへの公開とそれに伴う諸々の作業に取り組みました。

## 背景と目的

開発してきたPythonパッケージを、Python Package Index (PyPI) で公開し、誰でも `pip install` でインストールできるようにすることが最終的な目的です。プロジェクトにはリリースガイドが用意されているので、それに従って確実なリリースを目指します。

## 検討内容

リリースガイドには、バージョン更新、変更履歴の記載、リリースブランチ作成、GitHubでのリリース作成、PyPI公開、そしてリリース後のブランチマージといった一連の手順が示されています。この手順に沿って一つずつ進める計画でした。

しかし、PyPI公開のステップで予期せぬ問題が発生しました。GitHub Actionsによる自動公開ワークフローは成功したにも関わらず、PyPI上で確認するとバージョンが古いままだったのです。

この原因を探るため、GitHub Actionsのログを詳細に確認し、パッケージのビルド設定ファイル（`setup.py`や`pyproject.toml`）の内容を再確認する必要が出てきました。また、その過程でPythonのシステム環境と仮想環境に関する問題にも直面しました。

## 実装内容

リリースガイドの最初のステップから順に進めました。

1.  **バージョン番号の更新**:
    まず、`setup.py`を開き、バージョンを`"0.1.0"`から`"1.0.0"`に変更しました。

    ```diff
      setup(
          name="content-converter",
    -     version="0.1.0",
    +     version="1.0.0",
          author="Centervil",
          author_email="info@centervil.example.com",
    ```

2.  **変更履歴の更新**:
    `CHANGELOG.md`に`[1.0.0]`セクションを追加し、`[Unreleased]`の内容を移動しました。

    ```diff
      ## [Unreleased]
    +
    +
    + ## [1.0.0] - 2024-06-08
    ```

3.  **リリースブランチの作成**:
    `release/v1.0.0`ブランチを作成し、上記の変更をコミットしてプッシュしました。

    ```bash
    git checkout -b release/v1.0.0 && git add setup.py CHANGELOG.md && git commit -m "Prepare release v1.0.0" && git push origin release/v1.0.0
    ```

    このコマンドは無事成功しました。

4.  **GitHubでリリース作成**:
    GitHubのWeb UIから`v1.0.0`タグでリリースを作成しました。これにより、PyPIへの自動公開ワークフローがトリガーされるはずです。

5.  **PyPIへの公開確認（問題発生）**:
    GitHub Actionsのワークフローは成功と表示されましたが、PyPIのプロジェクトページを確認すると、バージョンが`0.1.0`のままでした。

    原因を探るため、Actionsのログを確認しました。`deploy`ジョブの詳細を見ると、PyPIへのアップロードステップで`HTTPError: 400 Bad Request`が発生していました。これは通常、同じバージョンが既に存在する場合に起こります。

    なぜバージョンが`0.1.0`のままビルドされたのか？ローカルでパッケージをビルドしてみることにしました。まず`dist/`ディレクトリをクリーンアップして再ビルドを試みました。

    ```bash
    rm -rf dist/ && python3 -m build
    ```

    しかし、`python3 -m build`が`No module named build`で失敗。`pip install build`を試みると、システムのPython環境が外部管理モード（PEP 668）であるため、権限エラーでインストールできませんでした。

    ```bash
    pip install build
    ```

    ```
    error: externally-managed-environment
    × This environment is externally managed
    ╰─> To install Python packages system-wide, try apt install
    ...
    ```

    そこで、仮想環境を作成してその中でビルドツールをインストールし、改めてビルドを実行しました。

    ```bash
    python3 -m venv .venv && source .venv/bin/activate && pip install --upgrade pip && pip install build && python3 -m build
    ```

    このコマンドは成功し、`dist/`ディレクトリにパッケージが生成されました。しかし、生成されたファイル名を見ると`content_converter-0.1.0.tar.gz`や`content_converter-0.1.0-py3-none-any.whl`となっており、やはりバージョンが`0.1.0`でした。

    `setup.py`は`1.0.0`にしたはずなのに...？ここで、`pyproject.toml`の存在を思い出しました。確認すると、`pyproject.toml`にもバージョン指定があり、そちらが`"0.1.0"`のままでした。ビルドツールによっては`pyproject.toml`の設定が優先されるため、これが原因だと特定しました。

    ```toml
    [project]
    name = "content-converter"
    version = "0.1.0" # これが原因だった！
    ```

    PyPIは一度公開されたバージョンを上書きできないため、バージョンを`1.0.0`のまま再アップロードすることはできません。そこで、バージョンを`1.0.1`に上げて再リリースする方針に切り替えました。

6.  **バージョンを1.0.1に上げて再リリース**:
    `pyproject.toml`と`setup.py`の両方でバージョンを`1.0.1`に更新しました。

    ```diff
      [project]
      name = "content-converter"
    - version = "1.0.0"
    + version = "1.0.1"
      description = "マークダウンファイルを各種公開プラットフォーム用に変換するツール"
    ```

    ```diff
      setup(
          name="content-converter",
    -     version="1.0.0",
    +     version="1.0.1",
          author="Centervil",
          author_email="info@centervil.example.com",
    ```

    再度`dist/`をクリーンアップし、仮想環境でビルドを実行。今度は`content_converter-1.0.1...`というファイルが生成され、正しいバージョンでビルドできたことを確認しました。

    次に、`release/v1.0.1`ブランチを作成し、変更をコミット・プッシュしようとしました。

    ```bash
    git checkout -b release/v1.0.1 && git add setup.py pyproject.toml CHANGELOG.md && git commit -m "Prepare release v1.0.1" && git push origin release/v1.0.1
    ```

    しかし、このコマンドは途中で中断されたか、既にローカルにブランチが存在していたようで、ブランチ作成部分でエラーになりました。`git status`で確認すると、バージョン変更などのファイルが未コミットのまま残っていました。

    既存の`release/v1.0.1`ブランチに切り替え、未コミットの変更を改めてコミット・プッシュしました。

    ```bash
    git checkout release/v1.0.1
    git add . && git commit -m "Apply version 1.0.1 and update CHANGELOG for release" && git push origin release/v1.0.1
    ```

    これで、`release/v1.0.1`ブランチにバージョン1.0.1の変更が反映されました。

    再びGitHubのWeb UIから`v1.0.1`タグでリリースを作成しました。今度はGitHub Actionsのワークフローも成功し、PyPIのプロジェクトページでバージョン`1.0.1`が最新として表示されていることを確認できました。

7.  **mainブランチへのマージ**:
    リリースブランチの変更を`main`ブランチに取り込みました。

    ```bash
    git checkout main && git merge --no-ff release/v1.0.1 && git push origin main
    ```

    これも無事成功し、`main`ブランチが最新の状態になりました。

8.  