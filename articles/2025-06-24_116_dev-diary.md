---
title: "TTS音声の同一話者内での対話ごとの速度調整検証（開発日記 No.116）"
emoji: "🧪"
type: "idea"
topics: ["開発日記", "プログラミング", "TTS"]
published: false
---

:::message
この記事はgemini-2.0-flash-001によって自動生成されています。
:::

## 関連リンク

- [前回の開発日記](https://zenn.dev/centervil/articles/2025-06-23_115_dev-diary)

## はじめに

昨日はTTS（テキスト音声変換）の品質検証として、長文台本と自然な会話をテーマに取り組みました。特に話すペースの調整が課題として残りました。本日は、その課題を深掘りし、TTS音声の同一話者内での対話ごとの速度調整の検証を行います。

## 背景と目的

前回の開発でTTSの品質検証を行った際、話すペースの調整が重要な課題として浮上しました。特に、ポッドキャストのようなコンテンツでは、話者内での速度変化が自然な会話表現に不可欠です。そこで本日は、同一話者内での対話ごとに速度を調整できるか検証し、より自然な音声表現を目指します。

## 検討内容

現在のTTS実装が、同一話者内での対話ごとの速度調整に対応しているか調査します。具体的には、以下の点を確認します。

*   同一話者内での速度調整を行うためのAPIまたは設定の有無
*   速度調整のテストケースを作成し、実験を行う
*   実験結果を評価し、実現可能性を検討する

## 実装内容

以下の手順で実装と検証を行いました。

1.  `test_tts.py` を修正し、Google Gemini APIの音声合成機能がSSMLを直接処理できないことを踏まえ、SSMLファイルを解析して自然言語の指示を含むプロンプトに変換するように実装しました。
2.  同一話者内での対話ごとの速度調整を実現するため、`<prosody rate="...">` タグを「(ゆっくり話してください)」、「(速く話してください)」などの自然言語の指示に変換してプロンプトに含めるように変更しました。
3.  `tools/tts_test_dev/sample_script.ssml` を作成し、SSML形式での速度調整テストケースを定義しました。

    ```xml
    <speak xmlns="http://www.w3.org/2001/10/synthesis">
        <voice name="Puck">
            <s> Speaker 1: こんにちは。</s>
            <s> <prosody rate="slow"> (ゆっくり話してください) 今日はいい天気ですね。</s> </prosody>
            <s> Speaker 1: ええ、そうですね。</s>
            <s> <prosody rate="fast"> (速く話してください) どこかに出かけたい気分です。</s> </prosody>
        </voice>
    </speak>
    ```

4.  `output_audio_0.wav` を正常に生成し、同一話者内での速度調整が機能することを確認しました。
5.  `test_tts.py`、`sample_script.ssml`、`output_audio_0.wav` をGitコミット・プッシュしました。

## 技術的なポイント

今回の実装における技術的なポイントは以下の通りです。

*   Google Gemini APIがSSMLを直接サポートしていないため、SSMLを解析して自然言語の指示に変換する処理を実装した点。
*   `xml.etree.ElementTree` ライブラリを使用してSSMLファイルを解析する際に、名前空間を適切に扱う必要があった点。`<speak>` タグにSSMLの名前空間 `xmlns="http://www.w3.org/2001/10/synthesis)"` を追加することで、`findall` メソッドが要素を正しく認識できるようになりました。

## 所感

SSMLの解析処理は、最初はうまくいかず、何度も試行錯誤を繰り返しました。特に、名前空間の扱いに苦労しましたが、最終的に音声ファイルが生成されたときは達成感がありました。Google Gemini APIの制約の中で、工夫して目的を達成できたことが嬉しかったです。

GitHub CLIでのプルリクエスト作成時に、コミット済みであることとファイルパスの解釈に関するエラーが発生し、少し手間取りました。今後は、新規ブランチで作業し、プルリクエストを作成するフローを確立する必要があると感じました。

## 今後の課題

*   GitHub CLIでのプルリクエスト作成フローの確立
*   `test_tts.py`のSSML解析ロジックの改善（より複雑なSSML構造への対応、エラーハンドリングの強化）
*   音声生成の品質（特に自然さ）について、継続的な評価と改善
*   長文のSSML入力に対するパフォーマンスと安定性の検証

## まとめ

本日は、TTS音声の同一話者内での対話ごとの速度調整の検証を行い、SSMLを解析して自然言語の指示に変換することで、速度調整を実現できることを確認しました。今後は、SSML解析ロジックの改善や音声品質の向上に取り組んでいきます。今回の開発を通して、Google Gemini APIの特性を理解し、制約の中で目的を達成するための工夫を凝らすことの重要性を改めて認識しました。