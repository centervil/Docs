---
title: 統合テスト環境構築とAPI連携実装 ⚙️（開発日記 No.048）
emoji: ⚙️
type: idea
topics: ["開発日記", "統合テスト", "API連携"]
published: false
---
:::message
この記事はgemini-2.0-flash-001によって自動生成されています。
:::

## 関連リンク
- [前回の開発日記](https://zenn.dev/centervil/articles/2025-04-16_047_dev-diary)

## はじめに

昨日はnote.com APIクライアントの修正とエラーハンドリングモジュールの実装を終えました。今日は、いよいよ統合テストの作成と実行に取り組みます。APIキーの管理方法についても検討し、安全なテスト環境を構築していきます。

## 背景と目的

これまで、個々の機能のユニットテストは行ってきましたが、システム全体を連携させた統合テストはまだ十分ではありません。APIクライアントの実装が進んだ今、実際のAPIと連携したテストを行うことで、より実践的な動作検証が可能になります。また、エラーハンドリングやパフォーマンスなど、より高度なテストも実施したいと考えています。

## 検討内容

まず、APIキーを安全に管理する方法を検討しました。ハードコーディングは絶対に避けたいので、`.env`ファイルを使って環境変数を管理することにしました。`.env.example`ファイルで必要な変数を明示し、`.gitignore`に`.env`を追加して、誤ってコミットされるのを防ぎます。

次に、実際のAPIと連携したテストと、モックサーバーを使ったテストの両方を実装することにしました。これにより、開発初期段階ではモックで高速にテストを行い、ある程度開発が進んだら実際のAPIでより現実的なテストを行う、という柔軟なテスト戦略が可能になります。

## 実装内容

1.  **環境変数管理の改善**: `config.py`を更新し、環境変数の読み込みと管理を整理しました。ログ出力機能を追加して、設定状態を確認しやすくしました。

2.  **実際のAPIと連携した統合テストの作成**: `test_real_api_integration.py`を作成しました。環境変数`TEST_USE_REAL_API`でテスト実行の有無を制御できるようにしました。

3.  **OpenRouterクライアントの実装**: `scripts/clients/openrouter_client.py`を実装しました。チャット完了API呼び出しやAPI接続テスト機能を実装し、エラーハンドリングとログ記録機能を追加しました。

4.  **Note.comクライアントの実装**: `scripts/clients/note_client.py`を実装しました。ログイン、記事取得、記事作成、記事更新などの機能を実装しました。ウェブスクレイピングとAPIリクエストを組み合わせています。

5.  **モックAPIを使用した統合テストの実装**: `test_mock_api_integration.py`を作成し、各種エラーパターンのテストケースを実装しました。

6.  **プロジェクト進捗レポートの作成**: 全体進捗状況を可視化し、マイルストーンと次のステップを明確にしました。

## 技術的なポイント

*   **環境変数管理**: `python-dotenv`ライブラリを使用して、`.env`ファイルから環境変数を安全に読み込んでいます。
*   **APIクライアント**: `requests`ライブラリを使用して、OpenRouterとnote.comのAPIを呼び出しています。エラーハンドリングを丁寧に行い、API制限時の挙動も考慮しています。
*   **テスト実行の制御**: 環境変数`TEST_USE_REAL_API`を使って、実際のAPIを使ったテストとモックを使ったテストを切り替えられるようにしました。

## 所感

今日は統合テストの基盤を構築することができ、大きな前進を感じています。特に、APIキーの安全な管理方法を確立できたことは、今後の開発において非常に重要です。

APIクライアントの実装では、ウェブスクレイピングとAPIリクエストを組み合わせる必要があり、少し苦労しました。しかし、最終的には安定した動作を実現でき、達成感がありました。

進捗レポートを作成することで、プロジェクト全体の状況を改めて把握することができ、今後の計画を立てやすくなりました。

## 今後の課題

*   異常系テストケースの拡充: ネットワークエラーやAPI制限など、より多くの異常系ケースをテストする必要があります。
*   モックサーバーの作成によるテスト網羅性の向上: より複雑なAPIの挙動をモックできるように、モックサーバーを開発したいと考えています。
*   パフォーマンス測定機能の追加: テスト時にAPIのレスポンスタイムなどを測定し、パフォーマンスボトルネックを特定できるようにしたいです。

## まとめ

今日は統合テストの基本的な枠組みを設計・実装し、実際のAPIを使用したテストとモックを使用したテストの両方を設定しました。環境変数による切り替えを可能にし、柔軟なテスト戦略を実現しました。

明日は実際のAPIキーを使用してテストを実行し、システム全体の動作を検証します。また、異常系テストケースの拡充やモックサーバーの作成など、今後の課題にも取り組んでいきたいと思います。