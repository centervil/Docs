# 開発プロセスガイド (PM主導 & AIエージェント実行)

このドキュメントは、人間がプロジェクトマネージャー (PM) としてAIコーディングエージェント (Cursor, Cline, MCPなど) に指示を出す開発体制におけるプロセスとベストプラクティスを定義します。PMは開発目標を設定し、タスクをIssueとして定義、AIエージェントに実行を指示し、その成果物をレビュー・承認します。テスト駆動開発（TDD）とCI/CDパイプラインを中心とし、PMの指示とレビューのもとで、AIエージェントが高品質なコードを効率的に生成・修正することを目指します。

## 1. 開発スタイル (PMによる指示とAIによる実行)

### 1.1 設計原則の適用 (PMによる指示)

PMはAIエージェントにコード生成やリファクタリングを指示する際、以下の設計原則を遵守させます。

- **DRY (Don't Repeat Yourself)**: PMはAIに対し、冗長なコードの生成を避け、共通化を促す指示を出します。
  - 例: 「既存の `utils.py` の `calculate_value` 関数と同様のロジックです。この関数を利用するようにリファクタリングしてください。」

- **SOLID原則**: PMは、特に複雑なクラスやモジュールの設計・実装をAIに指示する場合、これらの原則を考慮するよう具体的に指示します。
  - 例: 「`OrderProcessor` クラスは現在、注文処理、通知、在庫更新の責務を持っています。単一責任の原則に従い、通知と在庫更新のロジックを別のクラスに分割してください。」

### 1.2 開発プロセス (PM指示 -> AI実行 -> PM確認)

- **テスト駆動開発 (TDD)**: PMがTDDサイクルを主導し、AIエージェントに各ステップの実行を指示します。
  - **PM指示 (Red)**: 「`module.py` に `new_feature` 関数のテストを `tests/unit/test_module.py` に追加してください。仕様は [Issue #123] を参照。まだ関数は実装しないでください。」
  - **AI実行**: AIがテストコードを生成。
  - **PM確認**: PMがテストコードをレビューし、`pytest` で失敗することを確認。
  - **PM指示 (Green)**: 「テスト `test_new_feature` がパスするように `module.py` に `new_feature` 関数を実装してください。基本的な実装で構いません。」
  - **AI実行**: AIが実装コードを生成。
  - **PM確認**: PMが実装コードをレビューし、`pytest` ですべてのテストがパスすることを確認。
  - **PM指示 (Refactor)**: 「`new_feature` 関数のコードをリファクタリングして、可読性を向上させてください。特にネストが深い箇所を改善してください。テストは引き続きパスするようにしてください。」
  - **AI実行**: AIがリファクタリングを実行。
  - **PM確認**: PMがリファクタリング後のコードをレビューし、テストがパスすることを確認。
  - **カバレッジ**: PMはカバレッジレポートを確認し、必要であればAIに「カバレッジレポートに基づき、`new_feature` 関数の未テスト分岐に対するテストケースを追加してください」と指示します。

- **継続的なリファクタリング**: PMはAIエージェントを活用し、コード品質の維持・向上を指示します。
  - PMは静的解析ツールの結果を確認し、AIに具体的な警告やエラーの修正を指示します。
  - PMは複雑度が高い箇所や読みにくいコードを特定し、AIにリファクタリング案を提案させ、承認後に実行を指示します。
  - PMは「ボーイスカウトルール」の考え方に基づき、「このファイルのこの部分の可読性を改善してください」といった指示をAIに出します。

- **コードレビュー (PMによる承認)**: AIエージェントが生成・修正したコードは、最終的にPM (または指名されたレビュアー) がレビューし、承認します。
  - PMは機能要件の充足、設計の妥当性、潜在的なバグ、セキュリティリスクなどを重点的に確認します。
  - AIへの指示内容と生成されたコードの整合性も確認します。
  - 問題があれば、PMは具体的な修正点をAIエージェントにフィードバック (再指示) します。承認されるまでこのサイクルを繰り返します。

### 1.3 Docker環境での開発 (PMによる環境指示)

開発環境とCI/CD環境の一貫性を保つため、Dockerを使用します。PMはAIエージェントに対し、Dockerコンテナ内での操作を前提とした指示を出します。

- **コンテナ内操作の指示**: PMはAIエージェントにファイル操作やコマンド実行を指示する際、コンテナ内での実行を指定します。
  - 例：「`docker-compose run --rm app pytest tests/unit/` を実行し、結果を報告してください。」
  - 例：「`app` コンテナ内の `/app/data/output.csv` を生成するスクリプトを作成してください。」
- **環境の一貫性**: PMはDockerを使用することで、AIエージェントが開発環境とCI/CD環境の違いを意識せずに済むようにします。
- **CI/CDとの統合**: PMは、AIエージェントによるコミット (PMが承認しマージされたもの) をトリガーとしてCI/CDパイプラインが実行されるように設定・管理します。

## 2. 実践的な開発フロー (PM主導 & AIエージェント中心)

### 2.1 開発の基本サイクル (PM指示 -> AI実行 -> PMレビュー -> PM統合)

`project_management_guide.md` で定義されたチケット駆動開発とHuman-In-The-Loopの原則に基づき、以下のサイクルで開発を進めます。

1.  **計画フェーズ (PM)**: PMがタスクを定義し、GitHub Issueを作成します。Issueには、背景、目的、期待される成果物、AIエージェントへの具体的な指示内容を記述します。
2.  **開発フェーズ (PM指示 -> AI実行)**: PMがIssueに基づきAIエージェントに指示を出します。AIはコード生成、テスト実行、ファイル操作などを行います。PMは必要に応じて中間成果物を確認し、軌道修正の指示や追加情報を提供します。
3.  **レビューフェーズ (PM)**: AIエージェントがタスク完了を報告したら、PMはその成果物 (コード、ドキュメントなど) をレビューします。レビュー観点は「1.2 コードレビュー」を参照。修正が必要な場合は、具体的なフィードバックを添えてAIに再指示します。
4.  **統合フェーズ (PM)**: PMがレビュー済みの成果物を承認し、対応するブランチをメインブランチにマージします。マージをトリガーとしてCI/CDパイプラインが実行され、自動テストやデプロイが行われます。

### 2.2 CI/CDパイプラインのアプローチ (PMによる設定と監視)

PMはCI/CDパイプラインを構築・管理し、AIエージェントの開発活動を支援・検証します。

1. **早期導入**: PMはプロジェクト初期からCI/CDパイプライン (テスト、静的解析) を構築します。
2. **段階的な拡張**: PMは必要に応じてセキュリティスキャン、パフォーマンスチェックなどをパイプラインに追加し、AI生成コードを含むすべてのコードに対する自動チェックを強化します。
3. **自動デプロイの設定**: PMは、テストとレビューをパスしたコードが自動的にステージング環境や本番環境にデプロイされるようにパイプラインを設定・管理します。
4. **モニタリングとフィードバック**: PMはデプロイ後のアプリケーションの動作を監視し、問題発生時は原因究明を行います。品質ダッシュボードの情報と合わせて、AIへの指示方法や開発プロセス自体の改善に繋げます。

### 2.3 テスト駆動開発（TDD）の標準手順 (PM指示 & AI実行)

#### テストファイル構成

PMはAIエージェントに対し、標準的なテストディレクトリ構造 (`tests/unit/`, `tests/integration/` など) に従ってテストファイルを配置するように指示します。

```
tests/
├── conftest.py          # 共通フィクスチャ (PMが設定、AIも利用)
├── unit/                # ユニットテスト
│   ├── test_module1.py  # PM指示 -> AI生成/編集
│   └── test_module2.py
├── integration/         # 統合テスト
│   └── test_feature_integration.py # PM指示 -> AI生成/編集
└── __init__.py
```

#### テストの種類と命名規則

PMはAIエージェントにテスト生成を指示する際、ユニットテスト (`test_*.py`) と統合テスト (`test_*_integration.py`) を区別し、適切な命名規則に従うように指示します。

#### テスト実行コマンド (Docker経由での指示)

PMはAIエージェントにテスト実行を指示する際、Dockerコンテナ経由で実行させ、結果の報告を求めます。

1. **すべてのテスト実行**: PM指示「`docker-compose run --rm test` を実行し、結果を報告してください」
2. **ユニットテストのみ**: PM指示「`docker-compose run --rm test-unit` を実行し、結果を報告してください」
3. **統合テストのみ**: PM指示「`docker-compose run --rm test-integration` を実行し、結果を報告してください」
4. **カバレッジ付き**: PM指示「`docker-compose run --rm test-coverage` を実行し、カバレッジレポート (例: `htmlcov/index.html`) を生成・保存してください」

#### TDDの具体的な実装フロー (PM指示 & AI実行)

「1.2 開発プロセス」のTDDの項で記述した、PMとAIの対話によるサイクルを実践します。

1.  PMがIssueに基づきテストケースを指示。
2.  AIが失敗するテストコードを生成。
3.  PMがテストコードを確認。
4.  PMが実装を指示。
5.  AIが実装コードを生成。
6.  PMが実装コードとテスト通過を確認。
7.  PMがリファクタリングを指示。
8.  AIがリファクタリング。
9.  PMがリファクタリング結果とテスト通過を確認。
10. PMがカバレッジを確認し、必要なら追加テストを指示。
11. PMが必要なら統合テストの追加を指示。

## 3. 品質管理と測定 (PMによる監視と改善)

### 3.1 品質指標

PMは `quality_dashboard_guide.md` で定義された指標（テストカバレッジ、静的解析スコア、ビルド成功率、PMレビュー時間、AI修正指示回数など）をダッシュボードで定期的に監視します。

### 3.2 継続的改善 (PM主導)

- **品質ダッシュボードの活用**: PMはダッシュボードの情報を基に、AIエージェントへの指示内容、プロンプト、利用ツール、開発プロセス自体を改善します。
- **技術的負債の管理**: PMはAIエージェントを活用して技術的負債を特定し、その解消を計画的にAIに指示します。
- **自動化の推進**: PMは定型的なリファクタリングやテスト追加など、AIエージェントによる自動化が有効な領域を見極め、活用を指示します。

## 4. ツールとリソース

### 4.1 推奨ツール

- **テストフレームワーク**: pytest
- **カバレッジ測定**: pytest-cov
- **静的解析**: flake8, pylint, mypy, bandit
- **CI/CD**: GitHub Actions
- **コンテナ化**: Docker, docker-compose
- **AIエージェント**: Cursor, Roo Code (Cline), その他MCP対応ツール
- **MCPサーバー**: 各種コミュニティ製サーバー
- **プロジェクト管理**: GitHub (Projects, Issues, PRs)
- **品質ダッシュボード**: Grafana, 静的HTML+JS, etc.

### 4.2 参考リソース

- [pytest ドキュメント](https://docs.pytest.org/)
- [GitHub Actions ドキュメント](https://docs.github.com/en/actions)
- [Docker ドキュメント](https://docs.docker.com/)
- [Model Context Protocol (MCP)](https://modelcontextprotocol.io/)
- (各AIエージェントのドキュメント)
- (本プロジェクト内の他のガイド: `project_management_guide.md`, `pytest_best_practices.md`, `quality_dashboard_guide.md`) 